<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Swarovski SCD Collection — Gallery</title>
  <style>
    :root{
      --bg:#f4f5f7;
      --panel:#ffffff;
      --text:#111318;
      --muted:#5a6270;
      --line:#e6e8ee;
      --shadow: 0 10px 26px rgba(17,19,24,.08);
      --radius: 16px;
      --chip:#eef0f5;
      --btn:#111318;
      --btnText:#fff;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: radial-gradient(1200px 700px at 20% 0%, #ffffff 0%, var(--bg) 55%, var(--bg) 100%);
      color:var(--text);
    }
    .wrap{max-width:1200px;margin:0 auto;padding:16px 14px 40px;}
    .topbar{
      position:sticky; top:10px; z-index:10;
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display:flex; gap:12px; align-items:center; justify-content:space-between;
    }
    .brand{min-width:220px}
    .brand h1{margin:0;font-size:16px;font-weight:800;letter-spacing:.2px}
    .brand p{margin:2px 0 0;font-size:12px;color:var(--muted)}
    .search{flex:1}
    .input{
      width:100%;
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 10px 12px;
      outline:none;
      font-size:14px;
      background: rgba(255,255,255,.96);
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 8px 10px;
      font-size:13px;
      color:var(--muted);
      display:flex; align-items:center; gap:8px;
      white-space:nowrap;
    }
    .pill input{accent-color:#111318}

    .admin{
      margin-top:14px;
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      display:none; /* shown only on desktop */
    }
    .admin h2{margin:0;font-size:14px}
    .muted{color:var(--muted);font-size:12px;margin:6px 0 0}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end; margin-top:10px}
    .field{display:flex; flex-direction:column; gap:6px; min-width:170px; flex:1}
    label{font-size:12px;color:var(--muted)}
    .field input, .field textarea{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding: 10px 10px;
      font-size:13px;
      outline:none;
      background: rgba(255,255,255,.96);
    }
    textarea{min-height:80px; resize:vertical}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .btn{
      border:0;
      border-radius: 999px;
      padding: 10px 12px;
      background: var(--btn);
      color: var(--btnText);
      font-weight:700;
      cursor:pointer;
      font-size:13px;
    }
    .btn.secondary{
      background: transparent;
      color: var(--text);
      border: 1px solid var(--line);
    }
    .btn:disabled{opacity:.55;cursor:not-allowed}

    .grid{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:14px; margin-top:16px;}
    @media (max-width:1100px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:820px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}

    .card{
      background: rgba(255,255,255,.92);
      border:1px solid var(--line);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 6px 18px rgba(17,19,24,.06);
      display:flex; flex-direction:column;
      min-height: 320px;
    }
    .thumb{
      width:100%;
      aspect-ratio: 4/3;
      background: linear-gradient(180deg,#fafbfc,#f0f2f6);
      border-bottom:1px solid var(--line);
      overflow:hidden;
      cursor:pointer;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .content{padding:12px;display:flex;flex-direction:column;gap:8px;flex:1}
    .titleRow{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .name{font-weight:800;font-size:14px;line-height:1.2}
    .price{font-weight:900;font-size:14px;white-space:nowrap}
    .specs{display:flex;flex-wrap:wrap;gap:6px}
    .chip{
      background: var(--chip);
      border:1px solid var(--line);
      border-radius: 999px;
      padding: 5px 8px;
      font-size:12px;
      color: var(--muted);
    }
    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:auto;gap:10px}
    .linkish{font-size:12px;color:var(--muted);cursor:pointer}
    .actions{display:flex;gap:8px}
    .miniBtn{
      border:1px solid var(--line);
      background: rgba(255,255,255,.92);
      border-radius: 999px;
      padding: 7px 10px;
      font-size:12px;
      cursor:pointer;
    }
    .miniBtn.danger{border-color:#f1c2c2;color:#a01212}

    /* Desktop-only admin panel */
    @media (min-width: 880px){
      .admin{display:block}
    }
    /* On small screens: hide edit toggle + admin completely (customer view) */
    @media (max-width: 879px){
      .pill{display:none}
      .admin{display:none !important}
    }

    /* Modal */
    .modalBack{
      position:fixed; inset:0;
      background:rgba(15,23,42,.45);
      display:none; align-items:center; justify-content:center;
      padding:14px; z-index:100;
    }
    .modal{
      width:min(760px,100%);
      background:var(--panel);
      border-radius:var(--radius);
      border:1px solid var(--line);
      box-shadow: var(--shadow);
      overflow:hidden;
      display:grid;
      grid-template-columns: 1fr 1.1fr;
    }
    @media (max-width:720px){.modal{grid-template-columns:1fr}}
    .modalImg{background:#f2f4f7;min-height:260px}
    .modalImg img{width:100%;height:100%;object-fit:cover;display:block}
    .modalBody{padding:14px;display:flex;flex-direction:column;gap:10px}
    .modalTitle{display:flex;justify-content:space-between;gap:10px;align-items:flex-start}
    .modalTitle h3{margin:0;font-size:16px}
    .closeX{border:1px solid var(--line);background:transparent;border-radius:999px;padding:7px 10px;cursor:pointer}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:8px 10px;font-size:13px}
    .k{color:var(--muted)}
    .copyBtn{border:1px solid var(--line);background:#fff;border-radius:999px;padding:6px 10px;font-size:12px;cursor:pointer}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <h1>Swarovski SCD Collection</h1>
        <p>Mobile = customer gallery · Desktop = simple editor</p>
      </div>

      <div class="search">
        <input id="search" class="input" placeholder="Search name, article #, cut, colour, clarity…" />
      </div>

      <div class="pill" title="Desktop only: enable to add/edit/delete">
        <input id="editToggle" type="checkbox" />
        <span>Edit mode</span>
      </div>
    </div>

    <div class="admin">
      <h2>Add / Edit item</h2>
      <p class="muted" id="status"></p>

      <div class="sep"></div>

      <div class="row">
        <div class="field"><label>Name</label><input id="fName" placeholder="e.g., SCD Round Solitaire"></div>
        <div class="field"><label>Price</label><input id="fPrice" placeholder="e.g., 399"></div>
        <div class="field"><label>Article Number</label><input id="fArticle" placeholder="e.g., 5681234"></div>
        <div class="field"><label>Carat</label><input id="fCarat" placeholder="e.g., 1.00"></div>
      </div>

      <div class="row">
        <div class="field"><label>Cut</label><input id="fCut" placeholder="e.g., Round"></div>
        <div class="field"><label>Colour</label><input id="fColour" placeholder="e.g., D"></div>
        <div class="field"><label>Clarity</label><input id="fClarity" placeholder="e.g., VVS1"></div>
        <div class="field"><label>Image URL</label><input id="fImage" placeholder="https://…"></div>
      </div>

      <div class="row">
        <div class="field" style="min-width:260px;flex:1.2">
          <label>Notes (optional)</label>
          <textarea id="fNotes" placeholder="Any notes…"></textarea>
        </div>
      </div>

      <div class="row" style="justify-content:space-between">
        <div class="row" style="gap:8px;margin-top:0">
          <button class="btn" id="saveBtn">Add item</button>
          <button class="btn secondary" id="clearBtn">Clear</button>
        </div>
        <div class="row" style="gap:8px;margin-top:0">
          <button class="btn secondary" id="importBtn">Import CSV</button>
          <button class="btn" id="exportBtn">Export CSV</button>
        </div>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="field" style="min-width:260px">
          <label>Published CSV URL (Google Sheet → Publish to web → CSV)</label>
          <input id="csvUrl" placeholder="Paste published CSV URL here">
        </div>
        <div class="field" style="min-width:260px">
          <label>Google Sheet URL (staff)</label>
          <input id="sheetUrl" placeholder="Paste editable Sheet URL here">
        </div>
        <div class="row" style="gap:8px;margin-top:0">
          <button class="btn secondary" id="saveLinksBtn">Save links</button>
          <button class="btn" id="loadCsvBtn">Load from published CSV</button>
          <a class="btn secondary" id="openSheetBtn" href="#" target="_blank" rel="noopener">Open Sheet</a>
        </div>
      </div>
      <p class="muted">Tip: edit in the app → Export CSV → import into Google Sheet tab to sync to iPad via the published CSV.</p>
    </div>

    <div class="grid" id="grid"></div>
  </div>

  <div class="modalBack" id="modalBack" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modalImg"><img id="mImg" alt=""></div>
      <div class="modalBody">
        <div class="modalTitle">
          <h3 id="mName">Item</h3>
          <button class="closeX" id="closeModal">Close</button>
        </div>
        <div class="specs" id="mChips"></div>
        <div class="kv" id="mKv"></div>
      </div>
    </div>
  </div>

  <input id="fileInput" type="file" accept=".csv,text/csv" style="display:none" />

  <script>
    const COLS = ["Name","Price","ArticleNumber","Carat","Cut","Colour","Clarity","ImageURL","Notes"];
    const KEY_ITEMS = "scd_items_v2_simple";
    const KEY_LINKS = "scd_links_v2_simple";

    const $ = (id) => document.getElementById(id);
    let items = [];
    let editMode = false;
    let editingIndex = null;

    function setStatus(msg){
      $("status").textContent = msg || "";
    }

    function esc(s){
      return String(s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    }

    function formatPrice(p){
      const n = Number(String(p ?? "").replace(/[^0-9.]/g,""));
      if (!isFinite(n)) return (p ?? "");
      return "$" + n.toLocaleString(undefined, {minimumFractionDigits:0, maximumFractionDigits:2});
    }

    function parseCSV(text){
      const rows = [];
      let row = [], cur = "", inQuotes = false;
      for (let i=0;i<text.length;i++){
        const ch = text[i], nx = text[i+1];
        if (inQuotes){
          if (ch === '"' && nx === '"'){ cur += '"'; i++; }
          else if (ch === '"'){ inQuotes = false; }
          else cur += ch;
        } else {
          if (ch === '"') inQuotes = true;
          else if (ch === ','){ row.push(cur); cur=""; }
          else if (ch === '\n'){ row.push(cur); cur=""; if(row.join("").trim()!=="") rows.push(row); row=[]; }
          else if (ch !== '\r') cur += ch;
        }
      }
      row.push(cur);
      if(row.join("").trim()!=="") rows.push(row);
      return rows;
    }

    function csvEscape(v){
      const s = String(v ?? "");
      return /[,"\n\r]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
    }

    function toCSV(arr){
      const out = [];
      out.push(COLS.join(","));
      for (const it of arr){
        out.push(COLS.map(c => csvEscape(it[c] ?? "")).join(","));
      }
      return out.join("\n");
    }

    function saveItems(){ localStorage.setItem(KEY_ITEMS, JSON.stringify(items)); }
    function loadItems(){
      try{
        const raw = localStorage.getItem(KEY_ITEMS);
        if(raw) items = JSON.parse(raw) || [];
      }catch{ items=[]; }
    }

    function saveLinks(){
      const links = { csvUrl: $("csvUrl").value.trim(), sheetUrl: $("sheetUrl").value.trim() };
      localStorage.setItem(KEY_LINKS, JSON.stringify(links));
      updateSheetLink();
      setStatus("Links saved.");
      setTimeout(()=>setStatus(""), 1200);
    }

    function loadLinks(){
      try{
        const raw = localStorage.getItem(KEY_LINKS);
        if(!raw) return;
        const links = JSON.parse(raw);
        $("csvUrl").value = links.csvUrl || "";
        $("sheetUrl").value = links.sheetUrl || "";
      }catch{}
      updateSheetLink();
    }

    function updateSheetLink(){
      const url = $("sheetUrl").value.trim();
      const a = $("openSheetBtn");
      if (!url){ a.href="#"; a.style.pointerEvents="none"; a.style.opacity=".6"; }
      else { a.href=url; a.style.pointerEvents="auto"; a.style.opacity="1"; }
    }

    function getSearchText(it){
      return ([
        it.Name, it.Price, it.ArticleNumber, it.Carat, it.Cut, it.Colour, it.Clarity, it.Notes
      ].join(" ") || "").toLowerCase();
    }

    function render(){
      const q = $("search").value.trim().toLowerCase();
      const list = q ? items.filter(it => getSearchText(it).includes(q)) : items;
      $("grid").innerHTML = list.map((it, idx) => {
        const chips = [
          it.Carat ? `<span class="chip">${esc(it.Carat)} ct</span>` : "",
          it.Cut ? `<span class="chip">${esc(it.Cut)}</span>` : "",
          it.Colour ? `<span class="chip">Colour ${esc(it.Colour)}</span>` : "",
          it.Clarity ? `<span class="chip">Clarity ${esc(it.Clarity)}</span>` : "",
        ].join("");

        const actions = editMode ? `
          <div class="actions">
            <button class="miniBtn" data-act="edit" data-i="${idx}">Edit</button>
            <button class="miniBtn danger" data-act="del" data-i="${idx}">Delete</button>
          </div>` : "";

        return `
          <div class="card">
            <div class="thumb" data-act="open" data-i="${idx}">
              ${it.ImageURL ? `<img src="${esc(it.ImageURL)}" alt="${esc(it.Name || "SCD")}" loading="lazy">`
                            : `<div class="muted" style="padding:18px">No image</div>`}
            </div>
            <div class="content">
              <div class="titleRow">
                <div class="name">${esc(it.Name || "Untitled")}</div>
                <div class="price">${esc(formatPrice(it.Price))}</div>
              </div>
              <div class="specs">${chips}</div>
              <div class="footer">
                <span class="linkish" data-act="open" data-i="${idx}">View details</span>
                ${actions}
              </div>
            </div>
          </div>`;
      }).join("");
    }

    function openModal(it){
      $("mImg").src = it.ImageURL || "";
      $("mImg").alt = it.Name || "SCD";
      $("mName").textContent = it.Name || "Item";

      $("mChips").innerHTML = [
        it.Price ? `<span class="chip">Price: ${esc(formatPrice(it.Price))}</span>` : "",
        it.Carat ? `<span class="chip">Carat: ${esc(it.Carat)}</span>` : "",
        it.Cut ? `<span class="chip">Cut: ${esc(it.Cut)}</span>` : "",
        it.Colour ? `<span class="chip">Colour: ${esc(it.Colour)}</span>` : "",
        it.Clarity ? `<span class="chip">Clarity: ${esc(it.Clarity)}</span>` : ""
      ].filter(Boolean).join("");

      const kv = [];
      kv.push(["Article Number", it.ArticleNumber || ""]);
      kv.push(["Carat", it.Carat || ""]);
      kv.push(["Cut", it.Cut || ""]);
      kv.push(["Colour", it.Colour || ""]);
      kv.push(["Clarity", it.Clarity || ""]);
      if (it.Notes) kv.push(["Notes", it.Notes]);

      $("mKv").innerHTML = kv.map(([k,v]) => `
        <div class="k">${esc(k)}</div>
        <div>
          ${esc(v)}
          ${k==="Article Number" && v ? ` <button class="copyBtn" data-copy="${esc(v)}">Copy</button>` : ""}
        </div>
      `).join("");

      $("modalBack").style.display="flex";
      $("modalBack").setAttribute("aria-hidden","false");
    }

    function closeModal(){
      $("modalBack").style.display="none";
      $("modalBack").setAttribute("aria-hidden","true");
    }

    function clearForm(){
      editingIndex = null;
      $("fName").value="";
      $("fPrice").value="";
      $("fArticle").value="";
      $("fCarat").value="";
      $("fCut").value="";
      $("fColour").value="";
      $("fClarity").value="";
      $("fImage").value="";
      $("fNotes").value="";
      $("saveBtn").textContent="Add item";
    }

    function getFormItem(){
      return {
        Name: $("fName").value.trim(),
        Price: $("fPrice").value.trim(),
        ArticleNumber: $("fArticle").value.trim(),
        Carat: $("fCarat").value.trim(),
        Cut: $("fCut").value.trim(),
        Colour: $("fColour").value.trim(),
        Clarity: $("fClarity").value.trim(),
        ImageURL: $("fImage").value.trim(),
        Notes: $("fNotes").value.trim(),
      };
    }

    function validate(it){
      if(!it.Name) return "Name required.";
      if(!it.ArticleNumber) return "Article Number required.";
      if(!it.ImageURL) return "Image URL required.";
      return "";
    }

    function upsert(){
      if(!editMode){ setStatus("Turn Edit mode ON first."); return; }
      const it = getFormItem();
      const err = validate(it);
      if(err){ setStatus(err); return; }

      if(editingIndex === null){
        items.unshift(it);
        setStatus("Added.");
      } else {
        items[editingIndex] = it;
        setStatus("Saved changes.");
      }
      saveItems();
      clearForm();
      render();
      setTimeout(()=>setStatus(""), 1200);
    }

    function startEdit(i){
      if(!editMode){ setStatus("Turn Edit mode ON first."); return; }
      const it = items[i]; if(!it) return;
      editingIndex = i;
      $("fName").value = it.Name || "";
      $("fPrice").value = it.Price || "";
      $("fArticle").value = it.ArticleNumber || "";
      $("fCarat").value = it.Carat || "";
      $("fCut").value = it.Cut || "";
      $("fColour").value = it.Colour || "";
      $("fClarity").value = it.Clarity || "";
      $("fImage").value = it.ImageURL || "";
      $("fNotes").value = it.Notes || "";
      $("saveBtn").textContent = "Save changes";
      setStatus("Editing: " + (it.Name || ""));
      window.scrollTo({top:0,behavior:"smooth"});
    }

    function del(i){
      if(!editMode){ setStatus("Turn Edit mode ON first."); return; }
      const it = items[i]; if(!it) return;
      if(!confirm(`Delete "${it.Name || "this item"}"?`)) return;
      items.splice(i,1);
      saveItems();
      render();
      setStatus("Deleted.");
      setTimeout(()=>setStatus(""), 1200);
    }

    function exportCSV(){
      const csv = toCSV(items);
      const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "SCD_Collection.csv";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      setStatus("Exported CSV.");
      setTimeout(()=>setStatus(""), 1200);
    }

    function importCSVText(text){
      const rows = parseCSV(text);
      if(!rows.length){ setStatus("CSV empty."); return; }
      const header = rows[0].map(h => (h||"").trim());
      const idx = {};
      header.forEach((h,i)=> idx[h]=i);

      const map = {
        Name: idx["Name"],
        Price: idx["Price"],
        ArticleNumber: idx["ArticleNumber"] ?? idx["Article Number"],
        Carat: idx["Carat"],
        Cut: idx["Cut"],
        Colour: idx["Colour"] ?? idx["Color"],
        Clarity: idx["Clarity"],
        ImageURL: idx["ImageURL"] ?? idx["Image URL"] ?? idx["Image"],
        Notes: idx["Notes"] ?? idx["Note"],
      };

      if(map.Name===undefined || map.ArticleNumber===undefined || map.ImageURL===undefined){
        setStatus("Missing required headers. Need: Name, ArticleNumber, ImageURL.");
        return;
      }

      const arr = [];
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        const it = {};
        for(const c of COLS){
          const i = map[c];
          it[c] = i===undefined ? "" : String(row[i] ?? "").trim();
        }
        if(!it.Name && !it.ArticleNumber) continue;
        arr.push(it);
      }
      items = arr;
      saveItems();
      clearForm();
      render();
      setStatus(`Imported ${items.length} items.`);
      setTimeout(()=>setStatus(""), 1400);
    }

    async function loadFromPublishedCSV(){
      const url = $("csvUrl").value.trim();
      if(!url){ setStatus("Paste a published CSV URL first."); return; }
      try{
        setStatus("Loading from published CSV…");
        const res = await fetch(url, {cache:"no-store"});
        if(!res.ok) throw new Error("HTTP "+res.status);
        const text = await res.text();
        importCSVText(text);
        setStatus("Loaded from published CSV.");
        setTimeout(()=>setStatus(""), 1400);
      }catch{
        setStatus("Failed to load CSV. Check publish settings / URL.");
      }
    }

    function setEdit(on){
      editMode = !!on;
      // Enable/disable editor controls
      const disabled = !editMode;
      ["fName","fPrice","fArticle","fCarat","fCut","fColour","fClarity","fImage","fNotes","saveBtn","clearBtn","importBtn","exportBtn"]
        .forEach(id => $(id).disabled = disabled);
      if(!editMode) clearForm();
      render();
      setStatus(editMode ? "Edit mode ON." : "Edit mode OFF.");
      setTimeout(()=>setStatus(""), 900);
    }

    // Event wiring (simple + reliable)
    document.addEventListener("click", (e) => {
      const t = e.target;

      // Card actions
      const act = t.getAttribute?.("data-act");
      if(act){
        const i = Number(t.getAttribute("data-i"));
        if(act==="open") openModal(items[i]);
        if(act==="edit") startEdit(i);
        if(act==="del") del(i);
        return;
      }

      // Copy article
      if(t.classList?.contains("copyBtn")){
        const v = t.getAttribute("data-copy") || "";
        navigator.clipboard?.writeText(v).then(()=>{
          t.textContent="Copied";
          setTimeout(()=>t.textContent="Copy", 900);
        }).catch(()=>{});
      }
    });

    $("closeModal").addEventListener("click", closeModal);
    $("modalBack").addEventListener("click", (e)=>{ if(e.target===$("modalBack")) closeModal(); });

    $("search").addEventListener("input", render);
    $("editToggle").addEventListener("change", (e)=> setEdit(e.target.checked));

    $("saveBtn").addEventListener("click", upsert);
    $("clearBtn").addEventListener("click", clearForm);
    $("exportBtn").addEventListener("click", exportCSV);
    $("saveLinksBtn").addEventListener("click", saveLinks);
    $("loadCsvBtn").addEventListener("click", loadFromPublishedCSV);
    $("sheetUrl").addEventListener("input", updateSheetLink);

    $("importBtn").addEventListener("click", ()=>{
      if(!editMode){ setStatus("Turn Edit mode ON first."); return; }
      $("fileInput").value="";
      $("fileInput").click();
    });
    $("fileInput").addEventListener("change", async (e)=>{
      const f = e.target.files?.[0];
      if(!f) return;
      const text = await f.text();
      importCSVText(text);
    });

    // Init
    loadItems();
    loadLinks();
    render();
    setEdit(false);
  </script>
</body>
</html>
